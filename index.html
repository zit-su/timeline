<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>Friends Timeline</title>

<!-- Firebase COMPAT SDKs (IMPORTANT) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#0f0f0f;
  color:#fff;
  font-family:system-ui,sans-serif;
}
header{
  background:#121212;
  padding:14px;
  text-align:center;
  font-size:18px;
}
.card{
  background:#1a1a1a;
  margin:12px;
  padding:12px;
  border-radius:16px;
}
button{
  background:#1e88e5;
  border:none;
  color:#fff;
  padding:10px 16px;
  border-radius:10px;
  font-size:14px;
}
input,textarea{
  width:100%;
  background:#111;
  color:#fff;
  border:1px solid #333;
  padding:8px;
  border-radius:10px;
  margin-top:6px;
}
img{
  width:100%;
  border-radius:14px;
}
.expired{
  text-align:center;
  color:#ff5252;
  font-weight:bold;
}
.hidden{display:none}
</style>
</head>

<body>

<header>ðŸ“¸ Friends Timeline</header>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <button onclick="login()">Login with Google</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

  <!-- CREATE POST -->
  <div class="card">
    <input type="file" id="file">
    <textarea id="caption" placeholder="What's happening?"></textarea>
    <button onclick="createPost()">Post</button>
  </div>

  <!-- TIMELINE -->
  <div id="timeline"></div>

</div>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBsJiEtH_lxeSgKH9ez8Iz0p1wy9svFLyc",
  authDomain: "chat-2024-ff149.firebaseapp.com",
  databaseURL: "https://chat-2024-ff149-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-2024-ff149",
  appId: "1:146349109253:web:0d3677e4239b7a7d19ac6c"
});

const auth = firebase.auth();
const db = firebase.database();

/* ============ CLOUDFLARE WORKER URL ============ */
const UPLOAD_URL = "https://timeline-upload.sunnymavale.workers.dev/upload";

/* ================= AUTH ================= */
auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    ensureUser();
    loadTimeline();
  }else{
    loginBox.classList.remove("hidden");
    app.classList.add("hidden");
  }
});

function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

/* ================= USER INIT ================= */
function ensureUser(){
  const u = auth.currentUser;
  db.ref("users/"+u.uid).update({
    name: u.displayName,
    photo: u.photoURL
  });
}

/* ================= CREATE POST ================= */
async function createPost(){
  const f = file.files[0];
  if(!f){
    alert("Select a file");
    return;
  }
  if(f.size > 10*1024*1024){
    alert("Max 10MB allowed");
    return;
  }

  const fd = new FormData();
  fd.append("file", f);

  const res = await fetch(UPLOAD_URL,{
    method:"POST",
    body:fd
  });

  const data = await res.json();
  if(!data.url){
    alert("Upload failed");
    return;
  }

  const uid = auth.currentUser.uid;
  const id = Date.now();

  db.ref("posts/"+uid+"/"+id).set({
    url: data.url,
    caption: caption.value || "",
    time: Date.now()
  });

  file.value="";
  caption.value="";
}

/* ================= LOAD TIMELINE ================= */
function loadTimeline(){
  const uid = auth.currentUser.uid;
  timeline.innerHTML="";

  db.ref("friends/"+uid).on("value",snap=>{
    timeline.innerHTML="";
    snap.forEach(friend=>{
      db.ref("posts/"+friend.key).once("value",ps=>{
        ps.forEach(p=>{
          const d = p.val();
          const age = Date.now() - d.time;

          const card = document.createElement("div");
          card.className="card";

          if(age > 7*24*60*60*1000){
            card.innerHTML = `<div class="expired">Timeline expired</div>`;
          }else{
            card.innerHTML = `
              <img src="${d.url}">
              <p>${d.caption}</p>
              <button onclick="sharePost('${d.url}')">Share</button>
            `;
          }

          timeline.appendChild(card);
        });
      });
    });
  });
}

/* ================= SHARE ================= */
function sharePost(url){
  if(navigator.share){
    navigator.share({url});
  }else{
    alert("Sharing not supported");
  }
}
</script>

</body>
</html>
