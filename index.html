<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>Timeline</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#0e0e0e;color:#fff;font-family:sans-serif}
header{padding:14px;text-align:center;font-size:18px;background:#121212}
.card{background:#1a1a1a;margin:12px;padding:12px;border-radius:16px}
button{background:#1e88e5;color:#fff;border:none;padding:10px 16px;border-radius:10px}
input,textarea{width:100%;background:#111;color:#fff;border:1px solid #333;padding:8px;border-radius:10px}
img,video{width:100%;border-radius:14px}
.expired{text-align:center;color:#ff5252;font-weight:bold}
</style>
</head>

<body>

<header>ðŸ“¸ Friends Timeline</header>

<div id="login" class="card">
  <button onclick="login()">Login with Google</button>
</div>

<div id="app" style="display:none">

<div class="card">
  <input type="file" id="file">
  <textarea id="caption" placeholder="What's new?"></textarea>
  <button onclick="createPost()">Post</button>
</div>

<div id="timeline"></div>

</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBPF1VE82Y3VkZe6IibjqKxBC-XHjM_Wco",
  authDomain: "chat-2024-ff149.firebaseapp.com",
  databaseURL: "https://chat-2024-ff149-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-2024-ff149"
});

const auth = firebase.auth();
const db = firebase.database();

/* ðŸ‘‰ PUT YOUR CLOUDFLARE WORKER UPLOAD URL HERE */
const UPLOAD_URL = "https://timeline-upload.sunnymavale.workers.dev/";

auth.onAuthStateChanged(u=>{
  if(u){
    login.style.display="none";
    app.style.display="block";
    loadTimeline();
  }
});

function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

async function createPost(){
  const f = file.files[0];
  if(!f || f.size > 10*1024*1024){
    alert("Max 10MB allowed");
    return;
  }

  const fd = new FormData();
  fd.append("file",f);

  const r = await fetch(UPLOAD_URL,{method:"POST",body:fd});
  const d = await r.json();

  const uid = auth.currentUser.uid;
  const id = Date.now();

  db.ref("posts/"+uid+"/"+id).set({
    url: d.url,
    caption: caption.value,
    time: Date.now()
  });

  file.value="";
  caption.value="";
}

function loadTimeline(){
  const uid = auth.currentUser.uid;
  timeline.innerHTML="";

  db.ref("friends/"+uid).on("value",f=>{
    timeline.innerHTML="";
    f.forEach(fr=>{
      db.ref("posts/"+fr.key).once("value",ps=>{
        ps.forEach(p=>{
          const d=p.val();
          const age=Date.now()-d.time;
          const card=document.createElement("div");
          card.className="card";

          if(age>7*24*60*60*1000){
            card.innerHTML="<div class='expired'>Timeline expired</div>";
          }else{
            card.innerHTML=`
              <img src="${d.url}">
              <p>${d.caption||""}</p>
              <button onclick="share('${d.url}')">Share</button>
            `;
          }
          timeline.appendChild(card);
        });
      });
    });
  });
}

function share(u){
  navigator.share({url:u});
}
</script>

</body>
</html>
